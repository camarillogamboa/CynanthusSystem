<!DOCTYPE html>
<html
        lang="es"
        xmlns="http://www.w3.org/1999/xhtml"
        xmlns:th="http://www.thymeleaf.org"
        xmlns:sec="http://www.thymeleaf.org/extras/spring-security"
>
<head>
    <meta charset="UTF-8">
    <title>Cynanthus Dayi</title>
</head>
<body>

<!-- Vista del servidor actual -->
<div th:fragment="currentServerView" th:object="${currentServer}"
     class="d-flex flex-column h-100 rounded border"
     th:classappend="${theme.paneColor}+' '+${theme.borderColor}"
>
    <!-- Parte superior -->
    <div class="row m-2">

        <!-- Indicador de disponibilidad -->
        <div class="col-xs p-3" id="availableIndicatorContainer">
            <div class="spinner-border text-info"></div>
        </div>

        <!-- Area de titulo -->
        <div class="col">
            <div class="row m-0">
                <h2 id="serverTitle" th:text="*{name}" th:class="${theme.textColor}">Nombre servidor</h2>
            </div>
            <div class="row m-0">
                <h6 id="serverAddress" th:text="(*{address})+':'+(*{port})" th:class="${theme.textColor}">Dirección</h6>
            </div>
        </div>

        <!-- Acciones disponibles para el servidor (Solo si el usuario es ADMIN) -->
        <div sec:authorize="hasRole('ADMIN')" class="col-xs">
            <button
                    type="button"
                    class="btn btn-light"
                    data-toggle="modal"
                    data-target="#updateServerDialog"
                    title="Editar información del servidor"
            >
                <span><i class="fas fa-pen"></i></span>
            </button>
            <button
                    type="button"
                    class="btn btn-light"
                    data-toggle="modal"
                    data-target="#deleteServerDialog"
                    title="Eliminar información del servidor"
            >
                <span><i class="fas fa-trash"></i></span>
            </button>

            <section
                    th:replace="~{this::saveServerDialog('updateServerDialog','Actualizar información',${currentServer})}"></section>
            <section th:replace="~{components/modals::deleteDialog('deleteServerDialog','',*{id},*{name})}"></section>
        </div>

    </div>

    <!-- Parte de mensaje de no conexión -->
    <div id="unavailableMessageContainer" class="row m-0 d-none">
        <div class="alert alert-warning rounded-0 border-left-0 border-right-0 p-2 w-100">
            <p class="w-100 m-auto text-center"
               th:text="'No se logró establecer comunicación con el servidor. Verifique la dirección y puerto de referencia o asegurese que el microservicio correspondiente se esté ejecutando'">
            </p>
        </div>
    </div>

    <!-- Selector de contenido de vista de servidor -->
    <div class="row m-0 ml-2 mr-2">
        <ul
                class="nav nav-tabs w-100"
                th:classappend="${theme.borderColor}"
                th:with="isStorageServer = (*{serverType.name}) == 'STORAGE', linkTheme = ${theme.borderColor}+' '+${theme.textColor}"
        >

            <th:block th:if="!${isStorageServer}" th:switch="*{serverType.name}">
                <li th:case="'STREAM_DATA'" class="nav-item">
                    <a
                            class="nav-link"
                            th:classappend="${linkTheme}"
                            href="#"
                            th:text="'Nodos de sensado'"
                            onclick="appController.delegate.loadSensingNodesView(this)"
                    ></a>
                </li>
                <li th:case="'CONTROL'" class="nav-item">
                    <a
                            class="nav-link"
                            th:classappend="${linkTheme}"
                            href="#"
                            th:text="'Nodos de control'"
                            onclick="appController.delegate.loadControlNodesView(this)"
                    ></a>
                </li>
            </th:block>

            <!-- Opción de vista de propiedades (disponible para todos los servidores) -->
            <li class="nav-item">
                <a
                        class="nav-link"
                        th:classappend="${linkTheme}"
                        href="#"
                        th:text="'Propiedades'"
                        onclick="appController.delegate.loadPropertiesView(this)"
                >
                </a>
            </li>

            <!-- Opción de vista de registro de eventos -->
            <li class="nav-item">
                <a
                        class="nav-link"
                        th:classappend="${linkTheme}"
                        href="#"
                        th:text="'Registro del servidor'"
                        onclick="appController.delegate.loadLogView(this)"
                ></a>
            </li>

        </ul>
    </div>

    <!-- Contenido del selector según opción de vista elegida o por defecto -->
    <div
            class="row m-0 mr-2 ml-2 flex-fill border-left border-bottom border-right rounded-bottom"
            th:classappend="${theme.background}+' '+${theme.borderColor}"
    >
        <div id="serverMainContainer" class="container-fluid p-0">
            <div th:replace="~{this::serverSummaryView}"></div>
        </div>
    </div>

    <!-- Parte de información adicional del servidor -->
    <div class="row m-0 p-1">
        <p
                id="serverInfoText"
                class="m-0 p-0 w-100 text-center" th:text="(!${#strings.isEmpty(currentServer.info)})?*{info}:'---'"
                th:classappend="${theme.textColor}"
        >
        </p>
    </div>

</div>

<div th:fragment="serverSummaryView" class="row h-100 m-0">
    <div class="col m-auto text-center">
        <h6 th:text="'Selecciona una pestaña'"></h6>
    </div>
</div>

<section th:fragment="saveServerDialog(dialogId,title,serverInfo)">
    <div th:id="${dialogId}" class="modal fade">
        <div class="modal-dialog modal-dialog-centered modal-lg">
            <div class="modal-content">
                <div th:replace="~{components/modals::modalHeader(${dialogId},${title})}"></div>

                <form
                        th:id="${dialogId}+'-form'"
                        th:object="${serverInfo}"
                        method="POST"
                        novalidate
                >
                    <input
                            th:id="${dialogId}+'-id'"
                            th:value="*{id}"
                            name="id"
                            type="hidden"
                    />

                    <div class="modal-body" th:classappend="${theme.background}">

                        <div class="form-row">
                            <div class="col-md-6 mb-3">
                                <!-- Campo name -->
                                <div class="form-group">
                                    <label th:for="${dialogId}+'-name'" th:text="'Nombre de servidor'"></label>
                                    <input
                                            th:id="${dialogId}+'-name'"
                                            th:value="*{name}"
                                            name="name"
                                            type="text"
                                            class="form-control"
                                            th:placeholder="'Ingrese nombre de servidor a registrar'"
                                            required
                                            maxlength="45"
                                            pattern="[a-zA-Z_$][a-zA-Z\s\d_$]*"
                                    >
                                    <div class="valid-feedback" th:text="'¡Correcto!'"></div>
                                    <div class="invalid-feedback"
                                         th:text="'Ingresa un dato válido para este campo'"></div>
                                </div>
                            </div>
                            <div class="col-md-6 mb-3">
                                <!-- campo serverType -->
                                <div class="form-group">
                                    <label th:for="${dialogId}+'-serverType'" th:text="'Tipo de servidor'"></label>
                                    <select
                                            th:id="${dialogId}+'-serverType'"
                                            th:with="selectTo = *{serverType}? *{serverType.name}:'STORAGE'"
                                            name="serverType"
                                            class="custom-select"
                                            required
                                    >

                                        <option
                                                th:each="serverType : ${T(edu.cynanthus.domain.ServerType).values()}"
                                                th:value="${serverType.name}"
                                                th:text="${serverType.alias}"
                                                th:selected="${selectTo}==${serverType.name}"
                                        ></option>
                                    </select>
                                </div>
                            </div>
                        </div>

                        <div class="form-row">
                            <div class="col-md-6 mb-3">
                                <!-- campo address -->
                                <div class="form-group">
                                    <label th:for="${dialogId}+'-address'"
                                           th:text="'Dirección en red del servidor'"></label>
                                    <input
                                            th:id="${sectionId}+'-address'"
                                            th:value="*{address}"
                                            name="address"
                                            type="text"
                                            class="form-control"
                                            th:placeholder="'Ingrese dirección en red'"
                                            required
                                            maxlength="60"
                                    >
                                    <div class="valid-feedback" th:text="'¡Correcto!'"></div>
                                    <div class="invalid-feedback"
                                         th:text="'Ingresa un dato válido para este campo'"></div>
                                </div>

                            </div>
                            <div class="col-md-6 mb-3">
                                <!-- campo port -->
                                <div class="form-group">
                                    <label th:for="${dialogId}+'-port'" th:text="'Puerto'"></label>
                                    <input
                                            th:id="${dialogId}+'-port'"
                                            th:value="*{port}"
                                            name="port"
                                            type="number"
                                            class="form-control"
                                            th:placeholder="'Ingresa número de puerto'"
                                            required
                                            min="0"
                                            max="65536"
                                    >
                                    <div class="valid-feedback" th:text="'¡Correcto!'"></div>
                                    <div class="invalid-feedback"
                                         th:text="'Ingresa un dato válido para este campo'"></div>
                                </div>
                            </div>
                        </div>

                        <!-- campo info -->
                        <div class="form-group">
                            <label th:for="${dialogId}+'-info'" th:text="'Información adicional'"></label>
                            <textarea
                                    th:id="${dialogId}+'-info'"
                                    th:text="*{info}"
                                    name="info"
                                    class="form-control"
                                    th:placeholder="'Agrega información adicional (opcional)'"
                                    rows="2"
                                    maxlength="300"
                            >
                            </textarea>
                            <div class="valid-feedback" th:text="'¡Correcto!'"></div>
                            <div class="invalid-feedback" th:text="'Ingresa un dato válido para este campo'"></div>
                        </div>

                    </div>

                    <div th:replace="~{components/modals::submitFooter}"></div>

                </form>

            </div>
        </div>
    </div>
</section>

<div th:fragment="nodePane" class="container-fluid p-1 bg-light border-top border-bottom">
    <div class="row m-0">
        <div class="col p-0">

        </div>
        <div class="col-xs p-0">
            <button
                    id="addNodeButton"
                    type="button"
                    class="btn btn-primary pt-1 pr-2 pb-1 pl-2"
                    data-toggle="modal"
                    data-target="#addNodeDialog"
            >
                <i class="fas fa-plus"></i> <span id="addNodeButton-text" th:text="${'Regitsrar nodo'}"></span>
            </button>
        </div>
    </div>
</div>

<div th:fragment="sensingView" class="row m-0 pt-2 h-100">
    <div class="col p-0">
        <div class="d-flex flex-column h-100">
            <div class="row m-0">
                <div th:replace="~{this::nodePane}"></div>
            </div>
            <div class="row flex-fill m-0">
                <div class="container-fluid h-100 p-0">
                    <div th:replace="~{this::loadingView}"></div>
                </div>
            </div>
        </div>
    </div>
</div>

<div th:fragment="controlView" class="row pt-2 m-0 h-100">
    <div class="col p-0">
        <div class="d-flex flex-column h-100">
            <div class="row m-0">
                <div th:replace="~{this::nodePane}"></div>
            </div>
            <div class="row flex-fill m-0">
                <div class="container-fluid h-100 p-0">
                    <div th:replace="~{this::loadingView}"></div>
                </div>
            </div>
        </div>
    </div>
</div>

<div th:fragment="loadingView" class="row h-100 m-0">
    <div class="col text-center m-auto">
        <div class="spinner-grow text-info" role="status"></div>
        <div class="spinner-grow text-info" role="status"></div>
        <div class="spinner-grow text-info" role="status"></div>
    </div>
</div>

</body>
</html>